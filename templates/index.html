<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TechStore - Cat√°logo</title>
    <link rel="icon" href="{{ url_for('static', filename='logo.png') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"/>
    
    <style>
      body { background-color: #f8f9fa; }
      .product-card { transition: transform 0.2s; border: none; border-radius: 15px; overflow: hidden; }
      .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); }
      .cart-badge { position: absolute; top: 5px; right: 5px; font-size: 0.7rem; }
      
      /* Animaci√≥n suave para el carrito */
      .offcanvas { transition: transform 0.3s ease-in-out; }
    </style>
  </head>
  <body>
    
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm sticky-top">
      <div class="container">
        <a class="navbar-brand fw-bold" href="/"><i class="bi bi-cpu-fill me-2 text-primary"></i>TECHSTORE</a>
        
        <div class="d-flex align-items-center gap-3">
            
            {% if session.get('user_role') == 'admin' %}
                 <div class="d-flex align-items-center px-2 py-1 border border-secondary rounded bg-secondary bg-opacity-25">
                    <span class="text-white small fw-bold">Sede: {{ sucursal }}</span>
                 </div>
            {% else %}
                 <form action="/cambiar_sucursal" method="POST" class="d-flex">
                    <select name="nueva_sucursal" onchange="this.form.submit()" class="form-select form-select-sm bg-dark text-white border-secondary shadow-none" style="cursor: pointer; max-width: 140px;">
                      <option value="Quito" {% if sucursal == 'Quito' %}selected{% endif %}>üìç Quito</option>
                      <option value="Guayaquil" {% if sucursal == 'Guayaquil' %}selected{% endif %}>üåä Guayaquil</option>
                    </select>
                  </form>
            {% endif %}

            {% if session.get('user_role') != 'admin' %}
            <button class="btn btn-outline-light position-relative border-0" type="button" data-bs-toggle="offcanvas" data-bs-target="#cartSidebar">
                <i class="bi bi-cart3 fs-5"></i>
                <span class="badge rounded-pill bg-danger cart-badge" id="cart-count">0</span>
            </button>
            {% endif %}

            {% if session.get('user_name') %}
            <div class="dropdown">
                <button class="btn btn-sm btn-light dropdown-toggle fw-bold" type="button" data-bs-toggle="dropdown">
                <i class="bi bi-person-circle me-1"></i> {{ session['user_name'] }}
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                    {% if session.get('user_role') == 'admin' %}
                        <li><a class="dropdown-item text-primary fw-bold" href="/dashboard">Panel Admin</a></li>
                    {% else %}
                        <li><a class="dropdown-item" href="/perfil">Mis Compras</a></li>
                    {% endif %}
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="/logout">Cerrar Sesi√≥n</a></li>
                </ul>
            </div>
            {% else %}
                <a href="/login" class="btn btn-primary btn-sm fw-bold px-3">Ingresar</a>
            {% endif %}
        </div>
      </div>
    </nav>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="cartSidebar">
        <div class="offcanvas-header bg-primary text-white shadow-sm">
            <h5 class="offcanvas-title fw-bold"><i class="bi bi-cart-check-fill me-2"></i>Tu Cesta</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body d-flex flex-column bg-light">
            
            <div id="cart-items-container" class="flex-grow-1 overflow-auto pe-2">
                <div class="text-center mt-5 text-muted opacity-50">
                    <i class="bi bi-cart-x fs-1"></i>
                    <p class="mt-2 fw-bold">Tu carrito est√° vac√≠o</p>
                </div>
            </div>
            
            <div class="border-top pt-3 mt-3">
                <div class="d-flex justify-content-between mb-2 text-secondary">
                    <span>Subtotal:</span>
                    <span class="fw-bold" id="cart-subtotal">$0.00</span>
                </div>
                <div class="d-flex justify-content-between mb-3 align-items-center bg-white p-3 rounded shadow-sm">
                    <span class="fs-5 fw-bold text-dark">TOTAL:</span>
                    <span class="fs-4 fw-bold text-primary" id="cart-total">$0.00</span>
                </div>
                <button class="btn btn-success w-100 py-3 fw-bold rounded-3 shadow-sm text-uppercase" onclick="prepararCheckout()" id="btn-procesar" disabled>
                    Procesar Compra <i class="bi bi-arrow-right-short fs-4 align-middle ms-1"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="container mt-5">
        
        <div class="row mb-4 text-center">
            <div class="col-12">
                <h2 class="fw-bold text-dark">Cat√°logo en <span class="text-primary">{{ sucursal }}</span></h2>
                <p class="text-muted">Explora nuestra tecnolog√≠a disponible para entrega inmediata.</p>
            </div>
        </div>

        {% if request.args.get('error') %}
        <div class="alert alert-danger shadow-sm border-0 mb-4 rounded-3">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>{{ request.args.get('error') }}
        </div>
        {% endif %}

        <div class="row g-4">
            {% for p in productos %}
            <div class="col-md-4 col-lg-3">
                <div class="card h-100 product-card shadow-sm bg-white">
                    <div class="card-body p-3 d-flex flex-column">
                        <div class="bg-light rounded-4 p-5 text-center mb-3 position-relative">
                            <i class="bi bi-laptop fs-1 text-secondary opacity-25"></i>
                            {% if p.cantidad == 0 %}
                                <div class="position-absolute top-50 start-50 translate-middle badge bg-danger text-uppercase px-3 py-2 shadow-sm">Agotado</div>
                            {% endif %}
                        </div>
                        
                        <h6 class="fw-bold text-dark mb-1 text-truncate" title="{{ p.nombre }}">{{ p.nombre }}</h6>
                        <small class="text-muted mb-3 d-block">{{ p.marca }}</small>
                        
                        <div class="mt-auto">
                            <div class="d-flex justify-content-between align-items-end mb-3">
                                <span class="fs-5 fw-bold text-primary">${{ "{:,.2f}".format(p.precio) }}</span>
                                {% if p.cantidad > 0 %}
                                    <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 rounded-pill px-2">Stock: {{ p.cantidad }}</span>
                                {% endif %}
                            </div>

                            {% if session.get('user_role') == 'admin' %}
                                <button class="btn btn-secondary w-100 rounded-pill btn-sm" disabled style="opacity: 0.7;">
                                    <i class="bi bi-eye-fill me-2"></i>Vista Admin
                                </button>
                            {% else %}
                                {% if p.cantidad > 0 %}
                                    <button class="btn btn-outline-primary w-100 fw-bold rounded-pill btn-sm d-flex align-items-center justify-content-center"
                                            onclick='agregarAlCarrito("{{ p.Id_producto }}", "{{ p.nombre | replace("\"", "&quot;") }}", {{ p.precio }}, {{ p.cantidad }})'>
                                        <i class="bi bi-cart-plus me-2 fs-5"></i> Agregar
                                    </button>
                                {% else %}
                                    <button class="btn btn-light w-100 fw-bold rounded-pill btn-sm text-muted border" disabled>
                                        No Disponible
                                    </button>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="modal fade" id="checkoutModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <form action="/checkout" method="POST" class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title fw-bold"><i class="bi bi-bag-check-fill me-2"></i>Finalizar Pedido</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4 bg-light">
                    <input type="hidden" name="cart_data" id="hidden_cart_data">
                    
                    <div class="text-center mb-4 bg-white p-3 rounded shadow-sm border">
                        <p class="text-muted mb-1 small text-uppercase fw-bold">Resumen de Compra</p>
                        <h3 class="fw-bold text-success m-0" id="modal-total">$0.00</h3>
                        <small class="text-muted"><span id="modal-item-count">0</span> productos incluidos</small>
                    </div>

                    {% if not session.get('user_id') %}
                        <h6 class="fw-bold text-secondary border-bottom pb-2 mb-3 small text-uppercase">Tus Datos de Facturaci√≥n</h6>
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="small fw-bold text-muted">C√©dula / RUC</label>
                                <input type="number" name="id_cliente" class="form-control" required>
                            </div>
                            <div class="col-6">
                                <label class="small fw-bold text-muted">Tel√©fono</label>
                                <input type="text" name="telefono" class="form-control">
                            </div>
                            <div class="col-12">
                                <label class="small fw-bold text-muted">Nombre Completo</label>
                                <input type="text" name="nombre" class="form-control" required>
                            </div>
                            <div class="col-12">
                                <label class="small fw-bold text-muted">Correo Electr√≥nico</label>
                                <input type="email" name="correo" class="form-control" required>
                            </div>
                            <div class="col-12">
                                <label class="small fw-bold text-muted">Direcci√≥n</label>
                                <input type="text" name="direccion" class="form-control">
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-success d-flex align-items-center border-0 shadow-sm">
                            <div class="bg-white p-2 rounded-circle text-success me-3">
                                <i class="bi bi-person-check-fill fs-4"></i>
                            </div>
                            <div>
                                <small class="d-block text-uppercase fw-bold opacity-75">Cliente Registrado</small>
                                <strong class="fs-5">{{ session['user_name'] }}</strong>
                            </div>
                        </div>
                    {% endif %}
                </div>
                <div class="modal-footer border-0 bg-white p-3">
                    <button type="button" class="btn btn-light text-secondary fw-bold" data-bs-dismiss="modal">Seguir comprando</button>
                    <button type="submit" class="btn btn-success px-4 fw-bold shadow">Confirmar y Pagar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Inicializamos el carrito (podr√≠a guardarse en LocalStorage si quisieras persistencia)
        let carrito = [];

        function agregarAlCarrito(id, nombre, precio, stockMax) {
            const existe = carrito.find(item => item.id === id);
            
            if (existe) {
                if (existe.cantidad < stockMax) {
                    existe.cantidad++;
                } else {
                    alert("¬°Has alcanzado el l√≠mite de stock disponible para este producto!");
                    return;
                }
            } else {
                carrito.push({ id, nombre, precio, cantidad: 1, stockMax });
            }
            actualizarUI();
            
            // Abrir el sidebar autom√°ticamente para mostrar feedback
            new bootstrap.Offcanvas(document.getElementById('cartSidebar')).show();
        }

        function cambiarCantidad(id, delta) {
            const item = carrito.find(i => i.id === id);
            if (!item) return;

            const nuevaCant = item.cantidad + delta;
            
            if (nuevaCant > 0 && nuevaCant <= item.stockMax) {
                item.cantidad = nuevaCant;
            } else if (nuevaCant <= 0) {
                // Si baja a 0, confirmamos eliminaci√≥n
                if(confirm("¬øQuitar producto del carrito?")) {
                    eliminarDelCarrito(id);
                    return;
                }
            } else if (nuevaCant > item.stockMax) {
                alert("No hay m√°s stock disponible.");
                return;
            }
            actualizarUI();
        }

        function eliminarDelCarrito(id) {
            carrito = carrito.filter(item => item.id !== id);
            actualizarUI();
        }

        function actualizarUI() {
            const contenedor = document.getElementById('cart-items-container');
            const contador = document.getElementById('cart-count');
            const subtotalEl = document.getElementById('cart-subtotal');
            const totalEl = document.getElementById('cart-total');
            const btnProcesar = document.getElementById('btn-procesar');

            // 1. Actualizar Badge
            const totalItems = carrito.reduce((sum, item) => sum + item.cantidad, 0);
            contador.innerText = totalItems;
            
            // 2. Renderizar Lista
            if (carrito.length === 0) {
                contenedor.innerHTML = `
                    <div class="text-center mt-5 text-muted opacity-50">
                        <i class="bi bi-cart-x fs-1"></i>
                        <p class="mt-2 fw-bold">Tu carrito est√° vac√≠o</p>
                    </div>`;
                btnProcesar.disabled = true;
            } else {
                contenedor.innerHTML = "";
                carrito.forEach(item => {
                    const totalItem = item.precio * item.cantidad;
                    contenedor.innerHTML += `
                    <div class="card mb-2 border-0 shadow-sm">
                        <div class="card-body p-2 d-flex align-items-center">
                            <div class="bg-white p-2 rounded border me-3 text-primary">
                                <i class="bi bi-box-seam"></i>
                            </div>
                            <div class="flex-grow-1 overflow-hidden">
                                <h6 class="m-0 small fw-bold text-truncate">${item.nombre}</h6>
                                <small class="text-muted">$${item.precio.toFixed(2)} x ${item.cantidad}</small>
                            </div>
                            <div class="d-flex align-items-center bg-light rounded px-1 me-2">
                                <button class="btn btn-sm px-1 py-0 text-secondary fw-bold" onclick="cambiarCantidad('${item.id}', -1)">-</button>
                                <span class="mx-2 small fw-bold">${item.cantidad}</span>
                                <button class="btn btn-sm px-1 py-0 text-primary fw-bold" onclick="cambiarCantidad('${item.id}', 1)">+</button>
                            </div>
                            <button class="btn btn-sm text-danger p-0" onclick="eliminarDelCarrito('${item.id}')"><i class="bi bi-trash-fill"></i></button>
                        </div>
                    </div>`;
                });
                btnProcesar.disabled = false;
            }

            // 3. Totales
            const total = carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
            subtotalEl.innerText = "$" + total.toFixed(2);
            totalEl.innerText = "$" + total.toFixed(2);
        }

        function prepararCheckout() {
            // Llenar datos en el modal final
            const total = carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
            const totalItems = carrito.reduce((sum, item) => sum + item.cantidad, 0);

            document.getElementById('modal-item-count').innerText = totalItems;
            document.getElementById('modal-total').innerText = "$" + total.toFixed(2);
            
            // Serializar el carrito para enviarlo al backend
            document.getElementById('hidden_cart_data').value = JSON.stringify(carrito);

            // Cerrar sidebar y abrir modal
            const sidebar = bootstrap.Offcanvas.getInstance(document.getElementById('cartSidebar'));
            sidebar.hide();
            new bootstrap.Modal(document.getElementById('checkoutModal')).show();
        }
    </script>
  </body>
</html>